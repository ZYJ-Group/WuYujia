# 3. 方法论 

本节介绍了所提出的 **GeoPrior-Tr 网络**的整体架构。该架构将点云补全视为一个**集合到集合（set-to-set）**的转换任务，其流程依次通过以下几个核心模块：

1. **点代理提取编码器 (3.1)**
2. **几何感知的 Transformer (3.2)**
3. **混合查询生成器 (3.3)**
4. **字典引导的解码器 (3.4)**
5. **特征驱动的重建头 (3.5)**

此外，还引入了**多任务训练策略 (3.6)** 和**复合损失函数 (3.7)** 来提升模型的鲁棒性和效果。

## 3.1 点代理提取编码器 (Point Agent Extraction Encoder)

1. **采样:** 首先使用**最远点采样 (Farthest Point Sampling, FPS)** 选取 K 个具有代表性的中心点，称为“点代理” (Point Agent)。
2. **特征提取:** 对于每个代理点，使用 **EdgeConv 算子**来提取其局部邻域的几何关系特征。
3. **编码:** 结合**位置编码**，生成每个点代理的最终特征表示，构成输入点云的特征集合 F。
4. **形式化:** 将点云补全问题定义为一个集合到集合的映射任务，由 Transformer 的编码器（ME）和解码器（MD）完成。

## 3.2 几何感知的 Transformer (Geometry-aware Transformer)

引入了两个关键机制来增强 Transformer：

1. **基于 Ball Query 的几何邻域建模:**
   - 在标准的自注意力之外，引入 Ball Query 策略（在半径 r 内检索 k 个邻居点，若不足则退化为 KNN）。
   - 通过聚合邻居特征，使模型能学习到局部的几何模式，为 Transformer 提供了显式的三维归纳偏置。
2. **门控融合机制 (Gated Fusion Mechanism):**
   - 设计一个可学习的门控参数 g。
   - 通过该门控，对全局注意力捕获的**语义信息 (f_global)** 和局部 Ball Query 感知的**几何特征 (f_local)** 进行加权融合。
   - 使得网络能够自适应地平衡全局与局部信息。

## 3.3 混合查询生成器 (Hybrid Query Generator)

生成粗补全坐标和查询特征的过程。

1. **混合查询源生成:** 查询点的坐标来源是混合的：
   - 一部分 (Q_pred) 由编码器输出的**全局特征**通过 MLP 预测生成。
   - 另一部分 (Q_fps) 直接从**输入点云**中通过 FPS 采样得到。
2. **查询点排序与选择:**
   - 将上述两种来源的查询点拼接为候选集。
   - 使用一个小型 MLP 对所有候选点**打分（0~1分）**，以评估其重要性。
   - 按得分降序排序，选择前 K 个点作为最终的**粗补全坐标 (P_coarse)**。
3. **特征-坐标融合:** 将全局特征和筛选出的粗坐标 P_coarse 拼接，通过 MLP 生成最终的**查询特征 (Q)**。

## 3.4 字典引导的 Transformer 解码器 (Dictionary-guided Transformer Decoder)

利用查询特征和编码器信息生成细化的补全点云，并通过形状先验字典引导进一步完善点云。

**3.4.1 Transformer 解码:**

- 一个标准的解码过程。
- 解码器以 3.3 节生成的查询 Q 作为 query，以 3.1 节编码器输出的特征 V 作为 key/value。
- 通过多层交叉注意力计算，输出细化的特征 Q’。

**3.4.2 正交字典引导模块 (Dictionary Guidance Module):**

- 引入可学习的**形状先验（字典 D）**来补偿缺失的几何细节。
- **Refine 单元:** 计算细化特征 Q’ 与字典 D 之间的特征相似度，然后根据相似度加权聚合字典向量，并与 Q’ 融合，得到最终的优化特征 Q_refined。
- **正交约束:** 为了保证字典中原型（先验知识）的判别性和独立性，引入**正交损失 (L_orth)**，防止冗余学习。

## 3.5 特征驱动的点云重建头 (Feature-driven Point Cloud Reconstruction Head)

将解码器输出的高维精炼特征 (Q_refined) 映射回最终的三维坐标空间，生成最终的精细坐标。

- **内容:**
  - 首先，将精炼特征 Q_refined、粗坐标 P_coarse 以及全局描述符三者拼接起来，构建一个融合特征。
  - 重建头基于这个融合特征，为 K 个粗坐标点中的每一个预测一个包含 S 个点的**相对坐标点片**（即偏移量）。
  - 最终的**精细点云 (P_fine)** 是通过将粗坐标 (P_coarse) 与预测的相对坐标点片相加生成的。

## 3.6 多任务与加权训练策略 (Multi-task and Weighted Training Strategy)

提高补全质量并稳定训练过程。

- 采用了两种策略：
  1. **去噪辅助任务:  **强迫模型学习并理解点云的“局部几何结构”和“表面平滑性”，从而提升点云补全的精细度和真实感
     - 在训练中，额外从输入点云中采样点并施加**高斯抖动**。
     - 将这些带噪的点与补全查询点一同送入解码器。
     - 模型以多任务的方式同时学习**补全**和**去噪**，以增强对局部几何的感知。
  2. **质量自适应加权策略:**
     - 在训练后期（例如 epoch >= 200 时）激活。
     - 根据 F-Score 等指标筛选出“高质量样本”。
     - 在计算损失时，为这些高质量样本赋予**更高权重 (1.0)**，其他样本权重为 0.5，使模型更专注于优化高质量的补全结果。

## 3.7 损失函数 (Loss Function)

设计一个复合损失函数来同时优化网络的多重任务目标。

- 损失函数由三个关键部分构成：
  1. **补全损失 (Completion Loss):**
     - 模型的主要损失，监督粗补全和精细补全点云。
     - 由 **Chamfer Distance L1 (CDL1)**、**Chamfer Distance L2 (CDL2)** 和 **Earth-Mover's Distance (EMD)** 加权和组成。
  2. **去噪损失 (Denoising Loss):**
     - 对应 3.6 节的去噪辅助任务，监督去噪分支的输出（使用 CDL1）。
  3. **正交损失 (Orthogonal Loss):**
     - 对应 3.4.2 节的字典引导模块，确保字典原型的独立性。
- **最终损失组合:**
  - 模型最终组合为两个独立的损失项（**稀疏损失 L_sparse** 和 **密集损失 L_dense**）进行反向传播。
  - L_sparse 由去噪损失构成。
  - L_dense 由（经 3.6 节策略加权后的）补全损失和正交损失构成。

